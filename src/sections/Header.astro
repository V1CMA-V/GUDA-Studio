---
import ButtonRegister from '@/components/ButtonRegister.astro'

const { pathname } = Astro.url

// Resaltar la clase activa en el menú de navegación
const isActive = (path: string) => pathname === path
---

<header
  class="fixed top-0 z-50 mx-auto flex items-center h-24 w-full select-none md:px-24 text-white sm:overflow-hidden"
>
  <div class="relative flex justify-between w-full items-center px-6 py-4">
    <div class="w-44 h-auto flex flex-col items-center justify-center">
      <a href="/" class="flex items-center gap-2 group logo-hover">
        <img
          src="/logo-white.webp"
          alt="Logo Guda Studio"
          class="transition-transform duration-300 group-hover:scale-110 group-hover:rotate-6 drop-shadow-lg"
        />
      </a>
    </div>

    <!-- Menú desktop -->
    <nav class="hidden md:flex items-center justify-between">
      <ul
        class="flex gap-8 text-lg font-light tracking-widest items-center justify-between uppercase"
        id="navContent"
      >
        <li>
          <a
            href="/"
            class=`${isActive('/') ? 'glow-text font-semibold text-2xl' : 'text-white hover:glow-text'}`
            >Inicio</a
          >
        </li>
        <li>
          <a
            href="/about"
            class=`${isActive('/about') ? 'glow-text font-semibold text-2xl' : 'text-white hover:glow-text'}`
            >Sobre Nosotros</a
          >
        </li>
        <li>
          <a
            href="/classes"
            class=`${isActive('/classes') ? 'glow-text font-semibold text-2xl' : 'text-white hover:glow-text'}`
            >Clases</a
          >
        </li>
        <li>
          <a
            href="/shop"
            class=`${isActive('/shop') ? 'glow-text font-semibold text-2xl' : 'text-white hover:glow-text'}`
            >Tienda</a
          >
        </li>
      </ul>
    </nav>

    <div class="flex items-center gap-4">
      <!-- Botón Inscríbete -->
      <div class="hidden md:block">
        <ButtonRegister />
      </div>
      <!-- Botón hamburguesa solo en mobile -->
      <button
        id="mobileMenuBtn"
        class="md:hidden flex flex-col gap-1.5 p-2 rounded focus:outline-none group z-[10000] relative"
        aria-label="Abrir menú"
        aria-expanded="false"
      >
        <span
          class="block w-7 h-1 rounded bg-primary transition-all group-hover:bg-text"
        ></span>
        <span
          class="block w-7 h-1 rounded bg-primary transition-all group-hover:bg-text"
        ></span>
        <span
          class="block w-7 h-1 rounded bg-primary transition-all group-hover:bg-text"
        ></span>
      </button>
    </div>
  </div>
</header>

<!-- Overlay y menú móvil -->
<nav
  id="mobileOverlay"
  class="fixed inset-0 backdrop-blur-md bg-black/80 z-[9999] h-screen w-full opacity-0 invisible transition-all duration-300 ease-in-out md:hidden"
>
  <!-- Exit button -->
  <button
    id="mobileMenuClose"
    class="absolute top-6 right-6 z-[10001] text-4xl font-bold text-white hover:text-primary transition-colors duration-200"
    aria-label="Cerrar menú">&times;</button
  >

  <!-- Navigation -->
  <div class="flex flex-col justify-center items-center h-full px-8">
    <ul
      id="mobileMenu"
      class="flex flex-col items-start gap-8 text-white tracking-widest"
    >
      <li
        class="transform translate-y-8 opacity-0 transition-all duration-300 delay-100"
      >
        <a
          href="/"
          class=`${isActive('/') ? 'glow-text font-bold' : 'text-white hover:glow-text font-medium'} text-3xl sm:text-5xl uppercase`
          >Inicio</a
        >
      </li>
      <li
        class="transform translate-y-8 opacity-0 transition-all duration-300 delay-200"
      >
        <a
          href="/about"
          class=`${isActive('/about') ? 'glow-text font-bold' : 'text-white hover:glow-text font-medium'} text-3xl sm:text-5xl uppercase`
          >Sobre Nosotros</a
        >
      </li>
      <li
        class="transform translate-y-8 opacity-0 transition-all duration-300 delay-300"
      >
        <a
          href="/classes"
          class=`${isActive('/classes') ? 'glow-text font-bold' : 'text-white hover:glow-text font-medium'} text-3xl sm:text-5xl uppercase`
          >Clases</a
        >
      </li>
      <li
        class="transform translate-y-8 opacity-0 transition-all duration-300 delay-400"
      >
        <a
          href="/shop"
          class=`${isActive('/shop') ? 'glow-text font-bold' : 'text-white hover:glow-text font-medium'} text-3xl sm:text-5xl uppercase`
          >Tienda</a
        >
      </li>
      <li
        class="transform translate-y-8 opacity-0 transition-all duration-300 delay-500 mt-8"
      >
        <ButtonRegister isBig />
      </li>
    </ul>
  </div>
</nav>

<style>
  header {
    background: transparent;
    animation: header-blur-scroll 0.3s linear both;
    animation-timeline: scroll();
    animation-range: 0 250px;
    border-bottom: 1px solid transparent;
  }

  .logo-hover img {
    transition:
      transform 0.3s cubic-bezier(0.4, 2, 0.4, 1),
      filter 0.2s;
  }
  .logo-hover:hover img {
    filter: drop-shadow(0 2px 12px #4079ff90);
    transform: scale(1.13) rotate(-6deg);
  }

  @keyframes header-blur-scroll {
    0% {
      backdrop-filter: blur(0px);
      background: transparent;
    }

    100% {
      backdrop-filter: blur(10px);
      background: rgba(0, 0, 0, 0.5);
      padding-bottom: var(--spacing-6);
      border-bottom-color: black;
    }
  }

  #navContent {
    transition:
      translate 0.3s ease-in-out,
      visibility 0.3s 0.3s;
  }

  #navContent.showing {
    visibility: visible;
    translate: 0 0;
    transition:
      translate 0.3s ease-in-out,
      visibility 0.3s;
  }

  /* Mobile menu animations */
  #mobileOverlay.open {
    opacity: 1;
    visibility: visible;
  }

  #mobileOverlay.open #mobileMenu li {
    transform: translateY(0);
    opacity: 1;
  }

  /* Hamburger button animation */
  #mobileMenuBtn {
    transition: all 0.3s ease;
  }

  #mobileMenuBtn span {
    transition: all 0.3s ease;
    transform-origin: center;
  }

  #mobileMenuBtn.open span:nth-child(1) {
    transform: rotate(45deg) translate(5px, 5px);
    background: white;
  }

  #mobileMenuBtn.open span:nth-child(2) {
    opacity: 0;
    transform: scale(0);
  }

  #mobileMenuBtn.open span:nth-child(3) {
    transform: rotate(-45deg) translate(7px, -6px);
    background: white;
  }

  /* Smooth link hover effects */
  #mobileMenu a {
    position: relative;
    display: inline-block;
    text-decoration: none;
    transition: all 0.3s ease;
  }

  #mobileMenu a:hover {
    transform: scale(1.05);
  }

  #mobileMenu a::after {
    content: '';
    position: absolute;
    width: 0;
    height: 2px;
    bottom: -4px;
    left: 50%;
    background: linear-gradient(90deg, #0a6e70, #4079ff);
    transition: all 0.3s ease;
    transform: translateX(-50%);
  }

  #mobileMenu a:hover::after {
    width: 100%;
  }
</style>

<script>
  function initMobileMenu() {
    const mobileMenuBtn = document.getElementById('mobileMenuBtn')
    const mobileOverlay = document.getElementById('mobileOverlay')
    const mobileMenuClose = document.getElementById('mobileMenuClose')
    const mobileMenuLinks = document.querySelectorAll('#mobileMenu a')
    const body = document.body
    let isMenuOpen = false

    // Verificar que los elementos existen
    if (!mobileMenuBtn || !mobileOverlay || !mobileMenuClose) {
      console.warn('Elementos del menú móvil no encontrados')
      return
    }

    // Función para prevenir el scroll del body
    function preventBodyScroll(prevent: boolean) {
      if (prevent) {
        const scrollY = window.scrollY
        body.style.position = 'fixed'
        body.style.top = `-${scrollY}px`
        body.style.width = '100%'
        body.style.overflow = 'hidden'
      } else {
        const scrollY = body.style.top
        body.style.position = ''
        body.style.top = ''
        body.style.width = ''
        body.style.overflow = ''
        window.scrollTo(0, parseInt(scrollY || '0') * -1)
      }
    }

    // Función para abrir el menú móvil
    function openMobileMenu() {
      if (isMenuOpen || !mobileOverlay || !mobileMenuBtn || !mobileMenuClose)
        return

      isMenuOpen = true
      mobileOverlay.classList.add('open')
      mobileMenuBtn.classList.add('open')
      preventBodyScroll(true)
      mobileMenuBtn.setAttribute('aria-expanded', 'true')
      mobileMenuBtn.setAttribute('aria-label', 'Cerrar menú')

      // Focus trap - enfocar el botón de cerrar
      setTimeout(() => {
        mobileMenuClose?.focus()
      }, 100)
    }

    // Función para cerrar el menú móvil
    function closeMobileMenu() {
      if (!isMenuOpen || !mobileOverlay || !mobileMenuBtn) return

      isMenuOpen = false
      mobileOverlay.classList.remove('open')
      mobileMenuBtn.classList.remove('open')
      preventBodyScroll(false)
      mobileMenuBtn.setAttribute('aria-expanded', 'false')
      mobileMenuBtn.setAttribute('aria-label', 'Abrir menú')

      // Devolver el foco al botón del menú
      mobileMenuBtn?.focus()
    }

    // Event listeners
    mobileMenuBtn.addEventListener('click', (e) => {
      e.stopPropagation()
      if (isMenuOpen) {
        closeMobileMenu()
      } else {
        openMobileMenu()
      }
    })

    mobileMenuClose.addEventListener('click', (e) => {
      e.stopPropagation()
      closeMobileMenu()
    })

    // Cerrar menú al hacer click en el overlay (fuera del contenido del menú)
    mobileOverlay.addEventListener('click', (e) => {
      if (e.target === mobileOverlay) {
        closeMobileMenu()
      }
    })

    // Cerrar menú con la tecla Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isMenuOpen) {
        e.preventDefault()
        closeMobileMenu()
      }
    })

    // Cerrar menú al hacer click en cualquier enlace del menú móvil
    mobileMenuLinks.forEach((link) => {
      link.addEventListener('click', () => {
        // Pequeño delay para permitir la navegación
        setTimeout(() => {
          closeMobileMenu()
        }, 150)
      })
    })

    // Cerrar menú al cambiar el tamaño de la ventana (responsive)
    window.addEventListener('resize', () => {
      if (window.innerWidth >= 768 && isMenuOpen) {
        closeMobileMenu()
      }
    })
  }

  // Inicializar cuando el DOM esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMobileMenu)
  } else {
    initMobileMenu()
  }

  // Re-inicializar en navegación client-side (para SPAs)
  document.addEventListener('astro:page-load', initMobileMenu)
</script>
